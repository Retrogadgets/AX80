#!/usr/bin/perl

use Cwd;

@cset=(	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	#0x0n
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	#0x1n
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x11,0x17,0x15,0x1a,0x16,0x1b,0x18,	#0x2n
	0x1c,0x1d,0x1e,0x1f,0x20,0x21,0x22,0x23,0x24,0x25,0x00,0x00,0x00,0x00,0x00,0x00,	#0x3n
	0x00,0x26,0x27,0x28,0x29,0x2a,0x2b,0x2c,0x2d,0x2e,0x2f,0x30,0x31,0x32,0x33,0x34,	#0x4n
	0x35,0x36,0x37,0x38,0x39,0x3a,0x3b,0x3c,0x3d,0x3e,0x3f,0x10,0x18,0x11,0x00,0x16,	#0x5n
	0x00,0x26,0x27,0x28,0x29,0x2a,0x2b,0x2c,0x2d,0x2e,0x2f,0x30,0x31,0x32,0x33,0x34,	#0x6n
	0x35,0x36,0x37,0x38,0x39,0x3a,0x3b,0x3c,0x3d,0x3e,0x3f,0x10,0x18,0x11,0x00,0x00		#0x7n
);


$dir=getcwd;

$dir =~ /TAPE_/;

$tnumber=$';

if (length($tnumber) != 3)
{
	die "wrong place\n";
}
$tnumber=$tnumber+0;

print "reading from tape $tnumber\n";

$offset=512+541184*$tnumber;

for($k=0;$k<=31;$k++)
{
	$foffset=$offset+16896*$k;
	$c=open(BREAD,"../../ax81_image.bin");
	binmode(BREAD);
	seek(BREAD,$foffset,0);
	for($i=0;$i<16896;$i++)
	{
		read(BREAD,$tdata[$i],1);
	}

	close(BREAD);
	if(ord($tdata[0]) < 128)
	{
		$fname="";
		for($i=0;$i<10;$i++)
		{
			$zchar=ord($tdata[$i]);
			$pchar="_";
			for($l=32;$l<128;$l++)
			{
				if(($zchar==$cset[$l]) && ($pchar eq "_"))
				{
					$pchar=chr($l);
				}
			}
			$fname.=$pchar;
		}
		$fname=uc($fname);
		$fname=~ s/ //g;
		$dname=">".$fname.".P";
		$flen=ord($tdata[10])+256*ord($tdata[11]);
		print "reading $fname ($flen bytes)\n";
		open(BWRITE,$dname);
		binmode(BWRITE);
		for($m=0;$m<$flen;$m++)
		{
			print BWRITE $tdata[$m+512];
		}
		
		close(BWRITE);
	
	}
}

