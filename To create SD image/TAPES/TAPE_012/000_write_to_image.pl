#!/usr/bin/perl

use Cwd;

$fmuster="*.P";
@fnames=<${fmuster}>;
$maxfile=$#fnames;
@fnames=sort(@fnames);


@cset=(	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	#0x0n
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	#0x1n
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x11,0x17,0x15,0x1a,0x16,0x1b,0x18,	#0x2n
	0x1c,0x1d,0x1e,0x1f,0x20,0x21,0x22,0x23,0x24,0x25,0x00,0x00,0x00,0x00,0x00,0x00,	#0x3n
	0x00,0x26,0x27,0x28,0x29,0x2a,0x2b,0x2c,0x2d,0x2e,0x2f,0x30,0x31,0x32,0x33,0x34,	#0x4n
	0x35,0x36,0x37,0x38,0x39,0x3a,0x3b,0x3c,0x3d,0x3e,0x3f,0x10,0x18,0x11,0x00,0x16,	#0x5n
	0x00,0x26,0x27,0x28,0x29,0x2a,0x2b,0x2c,0x2d,0x2e,0x2f,0x30,0x31,0x32,0x33,0x34,	#0x6n
	0x35,0x36,0x37,0x38,0x39,0x3a,0x3b,0x3c,0x3d,0x3e,0x3f,0x10,0x18,0x11,0x00,0x00		#0x7n
);


$dir=getcwd;

$dir =~ /TAPE_/;

$tnumber=$';

if (length($tnumber) != 3)
{
	die "wrong place\n";
}
$tnumber=$tnumber+0;

print "format tape $tnumber\n";
open(BWRITE,"+<../../ax81_image.bin");
binmode(BWRITE);
$offset=512+541184*$tnumber;
seek(BWRITE,$offset,0);

for($i=0;$i<540672;$i++)
{
	print BWRITE chr(255);
}
close(BWRITE);

for($k=0;$k<=$maxfile;$k++)
{
	$infile=$fnames[$k];
	$fname=$fnames[$k];
	$fname=~ /\./;
	$fname=$`;

	print "adding $infile\n";

	$dlen= -s $infile;

	$foffset=$offset+16896*$k;

	open(BREAD,$infile);
	binmode(BREAD);

	$fname.="          ";

	for($i=0;$i<16896;$i++)
	{
		$tdata[$i]=255;	
	}


	for($i=0;$i<10;$i++)
	{
		$tdata[$i]=$cset[ord(substr($fname,$i,1))];	
	}

	$lolen=$dlen%256;
	$hilen=($dlen-$lolen)/256;

	$tdata[10]=$lolen;
	$tdata[11]=$hilen;

	$dindex=512;

	for($i=0;$i<$dlen;$i++)
	{
		read(BREAD,$tbyte,1);
		$tdata[$dindex]=ord($tbyte);
		$dindex++;
	}

	close(BREAD);

	open(BWRITE,"+<../../ax81_image.bin");
	binmode(BWRITE);
	seek(BWRITE,$foffset,0);

	for($i=0;$i<16896;$i++)
	{
		print BWRITE chr($tdata[$i]);	
	}
	close(BWRITE);

}
